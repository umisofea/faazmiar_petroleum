<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - Faazmiar Petroleum News</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --blue: #1491BE;
      --green: #7BA54E;
      --darkgrey: #2F3E46;
      --white: #FFFFFF;
      --light-bg: #f8f9fa;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
    }
    
    .navbar-custom {
      background-color: var(--blue);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .navbar-custom .nav-link,
    .navbar-custom .navbar-brand {
      color: var(--white);
      transition: all 0.3s ease;
    }
    
    .navbar-custom .nav-link:hover {
      color: var(--white);
      transform: translateY(-2px);
    }
    
    .admin-hero {
      background: linear-gradient(rgba(47, 62, 70, 0.8), rgba(47, 62, 70, 0.8)), 
                  url('https://images.unsplash.com/photo-1581091226033-d5c48150dbaa?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
      background-size: cover;
      background-position: center;
      color: var(--white);
      padding: 80px 0;
    }
    
    .section-title {
      position: relative;
      margin-bottom: 30px;
      padding-bottom: 15px;
      font-weight: 700;
    }
    
    .section-title:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 60px;
      height: 3px;
      background-color: var(--blue);
    }
    
    .admin-card {
      background-color: var(--white);
      border-radius: 10px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .btn-admin {
      background-color: var(--blue);
      color: var(--white);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-admin:hover {
      background-color: var(--green);
      color: var(--white);
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background-color: #dc3545;
      color: white;
    }
    
    .btn-edit {
      background-color: #ffc107;
      color: black;
    }
    
    .btn-mark-read {
      background-color: #28a745;
      color: white;
    }
    
    .news-item {
      border-left: 4px solid var(--blue);
      padding-left: 15px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    
    .news-item:hover {
      transform: translateX(5px);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-control, .form-select {
      border-radius: 5px;
      padding: 12px;
      border: 1px solid #ddd;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 0.2rem rgba(20, 145, 190, 0.25);
    }
    
    .badge-unread {
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
    }
    
    .badge-read {
      background-color: #28a745;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
    }
    
    .message-row {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .message-row:hover {
      background-color: #f8f9fa;
    }
    
    .message-row.unread {
      font-weight: 600;
      background-color: #fff3cd;
    }
    
    .nav-tabs .nav-link {
      color: var(--darkgrey);
      font-weight: 600;
    }
    
    .nav-tabs .nav-link.active {
      color: var(--blue);
      border-color: #dee2e6 #dee2e6 #fff;
      border-bottom: 3px solid var(--blue);
    }
    
    .stats-card {
      background: linear-gradient(135deg, var(--blue), var(--green));
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stats-card p {
      margin: 0;
      opacity: 0.9;
    }
    
    footer {
      background-color: var(--darkgrey);
      color: var(--white);
      padding: 40px 0 20px;
    }
    
    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-custom navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <i class="fas fa-gas-pump me-2"></i>Faazmiar Petroleum
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
              data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" 
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="index.html#latest">Latest</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link active" href="admin.html">Admin</a></li>
        </ul>
        <div class="ms-3">
          <button class="btn btn-outline-light" id="logoutBtn"><i class="fas fa-sign-out-alt me-1"></i> Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <header class="admin-hero">
    <div class="container text-center">
      <h1 class="display-4 fw-bold mb-4">Admin Panel</h1>
      <p class="lead mb-5">Manage news content and contact messages</p>
    </div>
  </header>

  <section class="py-5">
    <div class="container">
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="totalNews">0</h3>
            <p><i class="fas fa-newspaper me-2"></i>Total Articles</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="totalMessages">0</h3>
            <p><i class="fas fa-envelope me-2"></i>Total Messages</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <h3 id="unreadMessages">0</h3>
            <p><i class="fas fa-bell me-2"></i>Unread Messages</p>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button">
            <i class="fas fa-newspaper me-2"></i>News Management
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button">
            <i class="fas fa-envelope me-2"></i>Messages <span class="badge bg-danger ms-2" id="unreadBadge">0</span>
          </button>
        </li>
      </ul>

      <div class="tab-content" id="adminTabContent">
        <!-- News Management Tab -->
        <div class="tab-pane fade show active" id="news" role="tabpanel">
          <div class="admin-card">
            <h2 class="section-title">News Management</h2>
            
            <div class="mb-5">
              <h4 id="formTitle">Add New Article</h4>
              <form id="newsForm">
                <input type="hidden" id="newsId">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="title">Title</label>
                      <input type="text" class="form-control" id="title" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="category">Category</label>
                      <select class="form-select" id="category" required>
                        <option value="">Select Category</option>
                        <option value="Exploration">Exploration</option>
                        <option value="Refining">Refining</option>
                        <option value="Market Trends">Market Trends</option>
                        <option value="Sustainability">Sustainability</option>
                        <option value="Technology">Technology</option>
                        <option value="Partnership">Partnership</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="imageUrl">Image URL</label>
                  <input type="text" class="form-control" id="imageUrl" required>
                </div>
                
                <div class="form-group">
                  <label for="content">Content</label>
                  <textarea class="form-control" id="content" rows="5" required></textarea>
                </div>
                
                <div class="form-group">
                  <label for="date">Date</label>
                  <input type="date" class="form-control" id="date" required>
                </div>
                
                <button type="submit" class="btn btn-admin me-2" id="saveBtn">Save Article</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
              </form>
            </div>
            
            <hr>
            
            <div>
              <h4>Existing Articles</h4>
              <div id="newsLoading" class="loading" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading news articles...</p>
              </div>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Category</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="newsList"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Messages Tab -->
        <div class="tab-pane fade" id="messages" role="tabpanel">
          <div class="admin-card">
            <h2 class="section-title">Contact Messages</h2>
            
            <div id="messagesLoading" class="loading" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading messages...</p>
            </div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="messagesList"></tbody>
              </table>
              <div id="noMessages" class="text-center py-5" style="display: none;">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">No messages yet</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Message Detail Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="messageModalTitle">Message Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="messageModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-mark-read" id="markAsReadBtn">Mark as Read</button>
          <button type="button" class="btn btn-delete" id="deleteMessageBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-4 mb-4 mb-lg-0">
          <h5 class="mb-4"><i class="fas fa-gas-pump me-2"></i>Faazmiar Petroleum</h5>
          <p>Providing the latest news and insights from the world of oil and gas exploration, refining, and market trends.</p>
        </div>
        <div class="col-lg-2 col-md-6 mb-4 mb-md-0">
          <h5 class="mb-4">Quick Links</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="index.html" class="text-white text-decoration-none">Home</a></li>
            <li class="mb-2"><a href="index.html#latest" class="text-white text-decoration-none">Latest News</a></li>
            <li class="mb-2"><a href="about.html" class="text-white text-decoration-none">About Us</a></li>
            <li class="mb-2"><a href="admin.html" class="text-white text-decoration-none">Admin</a></li>
          </ul>
        </div>
        <div class="col-lg-2 col-md-6 mb-4 mb-md-0">
          <h5 class="mb-4">Categories</h5>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="#" class="text-white text-decoration-none">Exploration</a></li>
            <li class="mb-2"><a href="#" class="text-white text-decoration-none">Refining</a></li>
            <li class="mb-2"><a href="#" class="text-white text-decoration-none">Market Trends</a></li>
            <li class="mb-2"><a href="#" class="text-white text-decoration-none">Sustainability</a></li>
          </ul>
        </div>
        <div class="col-lg-4">
          <h5 class="mb-4">Contact Us</h5>
          <p><i class="fas fa-map-marker-alt me-2"></i> No. 156.0.01, Kompleks Maluri, Jalan Jejaka, 55110 Kuala Lumpur.</p>
          <p><i class="fas fa-phone me-2"></i> +603 9200 8867</p>
          <p><i class="fas fa-envelope me-2"></i> contact@faazmiar.com</p>
        </div>
      </div>
      <hr class="my-4">
      <div class="text-center">
        <p class="mb-0">© 2025 Faazmiar Petroleum News. All Rights Reserved.</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // API Configuration
    const API_URL = 'http://localhost:3000/api'; // Replace with your actual API URL

    // Check login
    const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
    if (!isLoggedIn) {
      window.location.href = 'admin-login.html';
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
      sessionStorage.removeItem('adminLoggedIn');
      window.location.href = 'admin-login.html';
    });

    // News functions
    async function getNewsData() {
      try {
        document.getElementById('newsLoading').style.display = 'block';
        const response = await fetch(`${API_URL}/news`);
        if (response.ok) {
          const data = await response.json();
          return data;
        } else {
          console.error('Failed to fetch news');
          return [];
        }
      } catch (error) {
        console.error('Error fetching news:', error);
        return [];
      } finally {
        document.getElementById('newsLoading').style.display = 'none';
      }
    }

    async function displayNews() {
      const newsData = await getNewsData();
      const newsList = document.getElementById('newsList');
      newsList.innerHTML = '';

      if (newsData.length === 0) {
        newsList.innerHTML = '<tr><td colspan="4" class="text-center py-4">No news articles found</td></tr>';
        document.getElementById('totalNews').textContent = '0';
        return;
      }

      newsData.forEach(news => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${news.title}</td>
          <td><span class="badge bg-primary">${news.category}</span></td>
          <td>${formatDate(news.date)}</td>
          <td>
            <button class="btn btn-sm btn-edit me-1" onclick="editNews(${news.id})">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-sm btn-delete" onclick="deleteNews(${news.id})">
              <i class="fas fa-trash"></i> Delete
            </button>
          </td>
        `;
        newsList.appendChild(row);
      });
      
      document.getElementById('totalNews').textContent = newsData.length;
    }

    // Messages functions
    async function getContactMessages() {
      try {
        document.getElementById('messagesLoading').style.display = 'block';
        const response = await fetch(`${API_URL}/messages`);
        if (response.ok) {
          const data = await response.json();
          return data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
          console.error('Failed to fetch messages');
          return [];
        }
      } catch (error) {
        console.error('Error fetching messages:', error);
        return [];
      } finally {
        document.getElementById('messagesLoading').style.display = 'none';
      }
    }

    async function displayMessages() {
      const messages = await getContactMessages();
      const messagesList = document.getElementById('messagesList');
      const noMessages = document.getElementById('noMessages');
      
      messagesList.innerHTML = '';
      
      if (messages.length === 0) {
        noMessages.style.display = 'block';
        document.getElementById('totalMessages').textContent = '0';
        document.getElementById('unreadMessages').textContent = '0';
        document.getElementById('unreadBadge').textContent = '0';
        return;
      }
      
      noMessages.style.display = 'none';
      
      const unreadCount = messages.filter(m => m.status === 'unread').length;
      
      messages.forEach(msg => {
        const row = document.createElement('tr');
        row.className = `message-row ${msg.status}`;
        row.innerHTML = `
          <td>${formatDateTime(msg.timestamp)}</td>
          <td>${msg.firstName} ${msg.lastName}</td>
          <td>${msg.email}</td>
          <td>${msg.subject}</td>
          <td><span class="badge-${msg.status}">${msg.status}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="viewMessage(${msg.id})">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        `;
        messagesList.appendChild(row);
      });
      
      document.getElementById('totalMessages').textContent = messages.length;
      document.getElementById('unreadMessages').textContent = unreadCount;
      document.getElementById('unreadBadge').textContent = unreadCount;
    }

    let currentMessageId = null;

    window.viewMessage = async function(id) {
      try {
        const response = await fetch(`${API_URL}/messages/${id}`);
        if (response.ok) {
          const message = await response.json();
          currentMessageId = id;
          
          const modalBody = document.getElementById('messageModalBody');
          modalBody.innerHTML = `
            <div class="mb-3">
              <strong>From:</strong> ${message.firstName} ${message.lastName}<br>
              <strong>Email:</strong> ${message.email}<br>
              <strong>Phone:</strong> ${message.phone || 'Not provided'}<br>
              <strong>Date:</strong> ${formatDateTime(message.timestamp)}<br>
              <strong>Status:</strong> <span class="badge-${message.status}">${message.status}</span>
            </div>
            <hr>
            <div class="mb-3">
              <strong>Subject:</strong><br>
              ${message.subject}
            </div>
            <hr>
            <div>
              <strong>Message:</strong><br>
              ${message.message.replace(/\n/g, '<br>')}
            </div>
          `;
          
          const modal = new bootstrap.Modal(document.getElementById('messageModal'));
          modal.show();
        } else {
          alert('Failed to fetch message details');
        }
      } catch (error) {
        console.error('Error fetching message:', error);
        alert('Error fetching message details');
      }
    };

    document.getElementById('markAsReadBtn').addEventListener('click', async function() {
      if (currentMessageId) {
        try {
          const response = await fetch(`${API_URL}/messages/${currentMessageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'read' })
          });
          
          if (response.ok) {
            await displayMessages();
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
          } else {
            alert('Failed to update message status');
          }
        } catch (error) {
          console.error('Error updating message:', error);
          alert('Error updating message status');
        }
      }
    });

    document.getElementById('deleteMessageBtn').addEventListener('click', async function() {
      if (currentMessageId && confirm('Are you sure you want to delete this message?')) {
        try {
          const response = await fetch(`${API_URL}/messages/${currentMessageId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            await displayMessages();
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
          } else {
            alert('Failed to delete message');
          }
        } catch (error) {
          console.error('Error deleting message:', error);
          alert('Error deleting message');
        }
      }
    });

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    function formatDateTime(dateString) {
      const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // News form handling
    document.getElementById('newsForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const newsId = document.getElementById('newsId').value;
      const title = document.getElementById('title').value;
      const category = document.getElementById('category').value;
      const imageUrl = document.getElementById('imageUrl').value;
      const content = document.getElementById('content').value;
      const date = document.getElementById('date').value;
      
      const newsData = {
        title: title,
        category: category,
        image_url: imageUrl,
        content: content,
        date: date
      };
      
      try {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        let response;
        if (newsId) {
          // Update
          response = await fetch(`${API_URL}/news/${newsId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newsData)
          });
        } else {
          // Create
          response = await fetch(`${API_URL}/news`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newsData)
          });
        }
        
        if (response.ok) {
          alert(newsId ? 'News updated successfully!' : 'News added successfully!');
          await displayNews();
          resetForm();
        } else {
          alert('Error saving news');
        }
      } catch (error) {
        console.error('Error saving news:', error);
        alert('Error saving news');
      } finally {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Article';
      }
    });

    window.editNews = async function(id) {
      try {
        const response = await fetch(`${API_URL}/news/${id}`);
        if (response.ok) {
          const news = await response.json();
          
          document.getElementById('newsId').value = news.id;
          document.getElementById('title').value = news.title;
          document.getElementById('category').value = news.category;
          document.getElementById('imageUrl').value = news.image_url;
          document.getElementById('content').value = news.content;
          document.getElementById('date').value = news.date;
          document.getElementById('formTitle').textContent = 'Edit Article';
          document.getElementById('newsForm').scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('Failed to fetch news details');
        }
      } catch (error) {
        console.error('Error fetching news:', error);
        alert('Error fetching news details');
      }
    };

    window.deleteNews = async function(id) {
      if (confirm('Are you sure you want to delete this news article?')) {
        try {
          const response = await fetch(`${API_URL}/news/${id}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            await displayNews();
            alert('News deleted successfully!');
          } else {
            alert('Failed to delete news');
          }
        } catch (error) {
          console.error('Error deleting news:', error);
          alert('Error deleting news');
        }
      }
    };

    document.getElementById('cancelBtn').addEventListener('click', resetForm);

    function resetForm() {
      document.getElementById('newsId').value = '';
      document.getElementById('newsForm').reset();
      document.getElementById('formTitle').textContent = 'Add New Article';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      displayNews();
      displayMessages();
      
      // Refresh messages every 30 seconds
      setInterval(displayMessages, 30000);
    });
  </script>
</body>
</html>